/*
 * jquery-linkroll - v0.0.1
 * A jQuery plugin to format a JSON bookmark file.
 * https://github.com/zachofalltrades/jquery.linkroll
 *
 * Made by Zach Shelton
 * Under  License
 */
!function(a){function b(b,e){var f=e,g=null,h=null,i=this,j=function(b){i.options=a.extend({},a.fn.linkroll.defaults,b),i.options.method=a.inArray(i.options.method,m)?i.options.method:m[0],i.options.jsonUrl&&(i.sourceUrl=i.options.jsonUrl),i.options.buttons===!0&&(i.options.buttons={loadFromFile:!0,loadFromUrl:!0,exportJson:!0,editJson:!0,reloadFromUrl:!0,clear:!0})},k=function(a){var b=a;i.options.useProxy&&-1===a.indexOf(n)&&(b=n+a),g=b};this.buildFromJson=function(b){var e=this.options,g=e.jsonTemplate,i=e.onSuccess;h=d(b);var j=[];g.begin&&j.push(g.begin),c(j,g,h),g.end&&j.push(g.end),f.html(j.join("")),e.addClass&&f.addClass(e.addClass),a.isFunction(i)&&i(f)},this.clear=function(){f&&f.empty()},this.reload=function(){g&&f&&i.loadFromJsonUrl(g)},this.loadFromJsonUrl=function(b){k(b),a.getJSON(g).done(function(a){i.buildFromJson(a)})},j(b)}function c(a,b,d){if(Array.isArray(d.children))for(var e in d.children){var f=d.children[e];Array.isArray(f.children)?(a.push(b.beforeEachCategory+f.name+b.afterEachCategory),a.push(b.beforeChildren),c(a,b,f),a.push(b.afterChildren)):"string"==typeof f.uri?(b.beforeEachLink&&a.push(i(f,b.beforeEachLink,b)),b.eachLink&&a.push(i(f,b.eachLink,b)),b.afterEachLink&&a.push(i(f,b.afterEachLink,b))):(j("!!!!!! UNEXPECTED OBJECT !!!!!!"),j(f))}else j("!!!!!!!!!!  NOT A FOLDER   !!!!!!!!"),j(d)}function d(a){var b={};return Array.isArray(a)&&a.length>0&&"string"==typeof a[0].category&&Array.isArray(a[0].links)?(b.name="old format",b.children=e(a)):"text/x-moz-place-container"===a.type?(b.name="Mozilla Bookmarks",b.children=g(a)):"object"==typeof a.roots&&"object"==typeof a.roots.other?(b.name="Chrome Bookmarks",b.children=f(a.roots.other)):"string"==typeof a.name&&Array.isArray(a.children)?b=a:(b.name="!!!!!!!   UNEXPECTED FORMAT   !!!!!!!!!",b.children=[]),j(b.name),b}function e(a){var b=[];return j(a),b}function f(a){var b=[];if(Array.isArray(a.children))for(var c in a.children){var d=a.children[c];if("folder"===d.type&&Array.isArray(d.children)&&d.children.length>0){var e=f(d),g={name:d.name,children:e};b.push(g)}else if("url"===d.type){var h={name:d.name,uri:d.url};b.push(h)}}return b}function g(a){var b=[];if(Array.isArray(a.children))for(var c in a.children){var d=a.children[c];if("text/x-moz-place-container"===d.type&&Array.isArray(d.children)&&d.children.length>0){var e=g(d),f={name:d.title,children:e};b.push(f)}else if("text/x-moz-place"===d.type){var h={name:d.title,uri:d.uri};b.push(h)}}return b}function h(a){return l+k.exec(a)[11]}function i(a,b,c){var d="string"==typeof a.uri?a.uri:a,e="string"==typeof a.name?a.name:k.exec(d)[11],f=b.replace(c.replaceWithIconUrl,h(d));return f=f.replace(c.replaceWithSiteUrl,d),f=f.replace(c.replaceWithSiteName,e)}function j(a){s&&window.console.log(a)}var k=/^(((([^:\/#\?]+:)?(?:(\/\/)((?:(([^:@\/#\?]+)(?:\:([^:@\/#\?]+))?)@)?(([^:\/#\?\]\[]+|\[[^\/\]@#?]+\])(?:\:([0-9]+))?))?)?)?((\/?(?:[^\/\?#]+\/+)*)([^\?#]*)))?(\?[^#]+)?)(#.*)?/,l="//www.google.com/s2/favicons?domain=",m=["append","prepend","before","after","html"],n="https://jsonp.nodejitsu.com/?callback=?&url=",o="https://jsonblob.com",p="/api/jsonBlob",q=window.File&&window.FileReader&&window.FileList,r=a.isFunction(a.fn.dialog),s=window.console&&window.console.log&&!0,t="feature not supported";a.fn.linkroll=function(c){return this.each(function(){var d=a(this),e=new b(c,d);return e.options.jsonUrl?e.loadFromJsonUrl(e.options.jsonUrl):(d.is("a")?e.insertImage(d):d.find("a").each(function(){var b=a(this);e.insertImage(b)}),a.isFunction(e.options.onSuccess)&&e.options.onSuccess(d)),e.options.buttons&&d.after(e.getWidget()),this})},a.fn.linkroll.methods=function(){return m.slice()},a.fn.linkroll.defaults={addClass:"linkroll",method:"append",jsonUrl:!1,useProxy:!1,onSuccess:!1,buttons:{loadFromFile:!1,loadFromUrl:!1,exportJson:!1,editJson:!1,reloadFromUrl:!1,clear:!1},jsonTemplate:{begin:"",beforeEachCategory:"<h3>",eachCategory:"<h3>##CATEGORY##</h3>",afterEachCategory:"</h3>",beforeChildren:"<div><ul>",afterChildren:"</ul></div>",beforeEachLink:"",eachLink:"<li class='linkroll' style=\"list-style-image: url('##ICONURL##');\"><a href='##SITEURL##'>##SITENAME##</a></li>",afterEachLink:"",end:"",replaceWithCategory:"##CATEGORY##",replaceWithIconUrl:"##ICONURL##",replaceWithSiteUrl:"##SITEURL##",replaceWithSiteName:"##SITENAME##"}},b.prototype={options:{},insertImage:function(b){var c=a(b).attr("href"),d=h(c),e=a("<img />",{src:d});this.options.addClass&&(e.addClass(this.options.addClass),b.addClass(this.options.addClass));var f=b[this.options.method];f.call(b,e)},getWidget:function(){var b=this.options.buttons,c=a("<div/>");return b&&(b.loadFromFile&&c.append(this.LoadFromFileButton()),b.loadFromUrl&&c.append(this.LoadFromUrlButton()),b.exportJson&&c.append(this.ExportButton()),b.editJson&&c.append(this.EditButton()),b.reloadFromUrl&&c.append(this.ReloadButton()),b.clear&&c.append(this.ClearButton())),this.myWidget=c,c},popup:function(b,c){var d=c?c:"LinkRoller";if(r&&this.myWidget){var e=window.innerHeight-10,f=window.innerWidth-10,g=a("<iframe height='"+(e-100)+"' width='"+(f-100)+"' frameborder='0' marginwidth='0' marginheight='0' src='"+b+"' />"),h=a("<div id='mydialog' />");h.append(g);var i=a("body");i.append(h),h.dialog({title:d,modal:!0,resizable:!0,height:"auto",width:f,close:function(){a("#mydialog").remove()}})}else{var j=window.open(b,d);j.focus()}},LoadFromFileButton:function(){var b=a("<span/>");if(q){var c=this,d=a("<input />",{type:"file",css:{visibility:"hidden",width:0,height:0}});d.attr("accept","json"),d.on("change",function(a){var b=a.target.files,d=b[0],e=new FileReader;e.onload=function(){return function(a){var b=a.target.result,d=JSON.parse(b);c.buildFromJson(d)}}(d),e.readAsText(d,"UTF-8")});var e=a("<button/>",{type:"button"});e.html("load from file"),e.click(function(){d.click()}),b.append(e),b.append(d)}else b.html(t);return b},LoadFromUrlButton:function(){var b=this,c=a("<span/>"),d=a("<input />",{type:"text"});d.bind("keypress",function(a){13===a.keyCode&&(a.preventDefault(),b.loadFromJsonUrl(d.val()))});var e=a("<button/>",{type:"button"});return e.html("load from url"),e.click(function(){b.loadFromJsonUrl(d.val())}),c.append(e),c.append(d),c},EditButton:function(){var b=a("<span/>");if(q){var c=this,d=a("<button/>",{type:"button"});d.html("edit"),d.click(function(){var b=c.sourceUrl&&c.sourceUrl.indexOf(o)>-1?!0:!1;if(b){var d=c.sourceUrl.replace(p,"");c.popup(d,"editing via JSONBlob service, save here, then reload")}else{var e=c.jsonModel,f=JSON.stringify(e);a.ajax({url:o+p,contentType:"application/json; charset=utf-8",type:"POST",data:f,error:function(a,b){alert(b)},success:function(a,b,d){var e=d.getResponseHeader("location");c.sourceUrl=e;var f=e.replace(p,"");c.popup(f,"editing via JSONBlob service, save here, then reload")}})}}),b.append(d)}else b.html(t);return b},ExportButton:function(){var b=a("<span/>");if(q){var c=this,d=a("<button/>",{type:"button"});d.html("export"),d.click(function(){var a=c.jsonModel,b=JSON.stringify(a,null," "),d=new Blob([b],{type:"application/json"});c.popup(URL.createObjectURL(d),"LinkRoller Data")}),b.append(d)}else b.html(t);return b},ReloadButton:function(){var b=this,c=a("<button/>");return c.html("reload"),c.click(function(){b.reload()}),c},ClearButton:function(){var b=this,c=a("<button/>");return c.html("clear"),c.click(function(){b.clear()}),c}}}(jQuery);