/*
 * jquery-linkroll - v0.0.1
 * A jQuery plugin to format a JSON bookmark file.
 * https://github.com/zachofalltrades/jquery.linkroll
 *
 * Made by Zach Shelton
 * Under  License
 */
!function(a){function b(b,e){var f=e,g=this,h=function(b){g.options=a.extend({},a.fn.linkroll.defaults,b),g.options.method=a.inArray(g.options.method,m)?g.options.method:m[0],g.options.jsonUrl&&(g.sourceUrl=g.options.jsonUrl),g.options.buttons===!0&&(g.options.buttons={loadFromFile:!0,loadFromUrl:!0,exportJson:!0,editJson:!0,reloadFromUrl:!0,clear:!0})},i=function(a){var b=a;g.options.useProxy&&-1===a.indexOf(n)&&(b=n+a),g.sourceUrl=b};this.loadFromJsonUrl=function(b){i(b),a.getJSON(this.sourceUrl).done(function(a){g.buildFromJson(a)})},this.buildFromJson=function(b){var e=this.options,h=e.jsonTemplate,i=e.onSuccess;g.jsonModel=d(b);var j=[];h.begin&&j.push(h.begin),c(j,h,g.jsonModel),h.end&&j.push(h.end),f.html(j.join("")),e.addClass&&f.addClass(e.addClass),a.isFunction(i)&&i(f)},h(b)}function c(a,b,d){if(Array.isArray(d.children))for(var e in d.children){var f=d.children[e];Array.isArray(f.children)?(a.push(b.beforeEachCategory+f.name+b.afterEachCategory),a.push(b.beforeChildren),c(a,b,f),a.push(b.afterChildren)):"string"==typeof f.uri?(b.beforeEachLink&&a.push(j(f,b.beforeEachLink,b)),b.eachLink&&a.push(j(f,b.eachLink,b)),b.afterEachLink&&a.push(j(f,b.afterEachLink,b))):(h("!!!!!! UNEXPECTED OBJECT !!!!!!"),h(f))}else h("!!!!!!!!!!  NOT A FOLDER   !!!!!!!!"),h(d)}function d(a){var b={};return Array.isArray(a)&&a.length>0&&"string"==typeof a[0].category&&Array.isArray(a[0].links)?(b.name="old format",b.children=e(a)):"text/x-moz-place-container"===a.type?(b.name="Mozilla Bookmarks",b.children=g(a)):"object"==typeof a.roots&&"object"==typeof a.roots.other?(b.name="Chrome Bookmarks",b.children=f(a.roots.other)):"string"==typeof a.name&&Array.isArray(a.children)?b=a:(b.name="!!!!!!!   UNEXPECTED FORMAT   !!!!!!!!!",b.children=[]),h(b.name),b}function e(){var a=[];return a}function f(a){var b=[];if(Array.isArray(a.children))for(var c in a.children){var d=a.children[c];if("folder"===d.type&&Array.isArray(d.children)&&d.children.length>0){var e=f(d),g={name:d.name,children:e};b.push(g)}else if("url"===d.type){var h={name:d.name,uri:d.url};b.push(h)}}return b}function g(a){var b=[];if(Array.isArray(a.children))for(var c in a.children){var d=a.children[c];if("text/x-moz-place-container"===d.type&&Array.isArray(d.children)&&d.children.length>0){var e=g(d),f={name:d.title,children:e};b.push(f)}else if("text/x-moz-place"===d.type){var h={name:d.title,uri:d.uri};b.push(h)}}return b}function h(a){s&&window.console.log(a)}function i(a){return l+k.exec(a)[11]}function j(a,b,c){var d="string"==typeof a.uri?a.uri:a,e="string"==typeof a.name?a.name:k.exec(d)[11],f=b.replace(c.replaceWithIconUrl,i(d));return f=f.replace(c.replaceWithSiteUrl,d),f=f.replace(c.replaceWithSiteName,e)}var k=/^(((([^:\/#\?]+:)?(?:(\/\/)((?:(([^:@\/#\?]+)(?:\:([^:@\/#\?]+))?)@)?(([^:\/#\?\]\[]+|\[[^\/\]@#?]+\])(?:\:([0-9]+))?))?)?)?((\/?(?:[^\/\?#]+\/+)*)([^\?#]*)))?(\?[^#]+)?)(#.*)?/,l="//www.google.com/s2/favicons?domain=",m=["append","prepend","before","after","html"],n="https://jsonp.nodejitsu.com/?callback=?&url=",o="https://jsonblob.com",p="/api/jsonBlob",q=window.File&&window.FileReader&&window.FileList,r=a.isFunction(a.fn.dialog),s=window.console&&window.console.log&&!0,t="feature not supported";a.fn.linkroll=function(c){return this.each(function(){var d=a(this),e=new b(c,d);return e.options.jsonUrl?e.loadFromJsonUrl(e.options.jsonUrl):(d.is("a")?e.insertImage(d):d.find("a").each(function(){var b=a(this);e.insertImage(b)}),a.isFunction(e.options.onSuccess)&&e.options.onSuccess(d)),e.options.buttons&&d.after(e.getWidget()),this})},a.fn.linkroll.methods=function(){return m.slice()},a.fn.linkroll.defaults={addClass:"linkroll",method:"append",jsonUrl:!1,useProxy:!1,onSuccess:!1,buttons:{loadFromFile:!1,loadFromUrl:!1,exportJson:!1,editJson:!1,reloadFromUrl:!1,clear:!1},jsonTemplate:{begin:"",beforeEachCategory:"<h3>",eachCategory:"<h3>##CATEGORY##</h3>",afterEachCategory:"</h3>",beforeChildren:"<div><ul>",afterChildren:"</ul></div>",beforeEachLink:"",eachLink:"<li class='linkroll' style=\"list-style-image: url('##ICONURL##');\"><a href='##SITEURL##'>##SITENAME##</a></li>",afterEachLink:"",end:"",replaceWithCategory:"##CATEGORY##",replaceWithIconUrl:"##ICONURL##",replaceWithSiteUrl:"##SITEURL##",replaceWithSiteName:"##SITENAME##"}},b.prototype={options:{},insertImage:function(b){var c=a(b).attr("href"),d=i(c),e=a("<img />",{src:d});this.options.addClass&&(e.addClass(this.options.addClass),b.addClass(this.options.addClass));var f=b[this.options.method];f.call(b,e)},getWidget:function(){var b=this.options.buttons,c=a("<div/>");return b&&(b.loadFromFile&&c.append(this.LoadFromFileButton()),b.loadFromUrl&&c.append(this.LoadFromUrlButton()),b.exportJson&&c.append(this.ExportButton()),b.editJson&&c.append(this.EditButton()),b.reloadFromUrl&&c.append(this.ReloadButton()),b.clear&&c.append(this.ClearButton())),this.myWidget=c,c},popup:function(b,c){if(r&&this.myWidget){var d=c?c:"LinkRoller",e=window.innerHeight-10,f=window.innerWidth-10,g=a("<iframe height='"+(e-100)+"' width='"+(f-100)+"' frameborder='0' marginwidth='0' marginheight='0' src='"+b+"' />"),h=a("<div id='mydialog' />");h.append(g);var i=a(this.myWidget);i.append(h),h.dialog({title:d,modal:!0,resizable:!0,height:"auto",width:f,close:function(){a("#mydialog").remove()}})}else{var j=window.open(b,d);j.focus()}},LoadFromFileButton:function(){var b=a("<span/>");if(q){var c=this,d=a("<input />",{type:"file",css:{visibility:"hidden",width:0,height:0}});d.attr("accept","json"),d.on("change",function(a){var b=a.target.files,d=b[0],e=new FileReader;e.onload=function(){return function(a){var b=a.target.result,d=JSON.parse(b);c.buildFromJson(d)}}(d),e.readAsText(d,"UTF-8")});var e=a("<button/>",{type:"button"});e.html("load from file"),e.click(function(){d.click()}),b.append(e),b.append(d)}else b.html(t);return b},LoadFromUrlButton:function(){var b=this,c=a("<span/>"),d=a("<input />",{type:"text"});d.bind("keypress",function(a){13==a.keyCode&&(a.preventDefault(),b.loadFromJsonUrl(d.val()))});var e=a("<button/>",{type:"button"});return e.html("load from url"),e.click(function(){b.loadFromJsonUrl(d.val())}),c.append(e),c.append(d),c},EditButton:function(){var b=a("<span/>");if(q){var c=this,d=a("<button/>",{type:"button"});d.html("edit"),d.click(function(){var b=c.sourceUrl&&c.sourceUrl.indexOf(o)>-1?!0:!1;if(b){var d=c.sourceUrl.replace(p,"");c.popup(d,"editing via JSONBlob service, save here, then reload")}else{var e=c.jsonModel,f=JSON.stringify(e);a.ajax({url:o+p,contentType:"application/json; charset=utf-8",type:"POST",data:f,error:function(a,b){alert(b)},success:function(a,b,d){var e=d.getResponseHeader("location");c.sourceUrl=e;var f=e.replace(p,"");c.popup(f,"editing via JSONBlob service, save here, then reload")}})}}),b.append(d)}else b.html(t);return b},ExportButton:function(){var b=a("<span/>");if(q){var c=this,d=a("<button/>",{type:"button"});d.html("export"),d.click(function(){var a=c.jsonModel,b=JSON.stringify(a,null," "),d=new Blob([b],{type:"application/json"});c.popup(URL.createObjectURL(d),"LinkRoller Data")}),b.append(d)}else b.html(t);return b},ReloadButton:function(){var b=this,c=a("<button/>");return c.html("reload"),c.click(function(){b.loadFromJsonUrl(b.sourceUrl)}),c},ClearButton:function(){var b=this,c=a("<button/>");return c.html("clear"),c.click(function(){b.targetNode.empty()}),c}}}(jQuery);