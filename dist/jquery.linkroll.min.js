/**
 * jquery-linkroll - v0.0.4 2015-02-26
 * A jQuery plugin to format a JSON bookmark file.
 * https://github.com/zachofalltrades/jquery.linkroll
 *
 * Copyright (c)2015 Zach Shelton
 * <zachofalltrades@users.sourceforge.net>  (http://zachofalltrades.net)
 * Released Under License:  MIT,GPL 
 */
!function(a,b,c){"use strict";function d(c,d){function i(c){E.options=a.extend({},a.fn.linkroll.defaults,c),E.options.method=a.inArray(E.options.method,u)?E.options.method:u[0];var d=n(E.options.buttons);if(d){var g=a("<div/>");if(d.file&&y&&g.append(e(j)),d.url&&g.append(f(l)),d.raw&&y&&(m=a("<button/>",{type:"button",disabled:!0}),m.html("export"),m.click(function(){var a=D,c=JSON.stringify(a,null," "),d=new b.Blob([c],{type:"application/json"});o(b.URL.createObjectURL(d),"LinkRoller Data")}),g.append(m)),d.edit&&y&&(s=a("<button/>",{type:"button",disabled:!0}),s.html("edit"),s.click(function(){var c=C&&C.indexOf(w)>-1?!0:!1;if(c){var d=C.replace(x,"");o(d,"editing via JSONBlob service, save here, then reload")}else{var e=JSON.stringify(D);a.ajax({url:w+x,contentType:"application/json; charset=utf-8",type:"POST",data:e,error:function(a,c){b.alert(c)},success:function(a,b,c){k(c.getResponseHeader("location"));var d=C.replace(x,"");o(d,"editing via JSONBlob service, save here, then reload")}})}}),g.append(s)),d.reload&&(z=a("<button/>",{disabled:!0}).html("reload").click(function(){l(C)}),a.isFunction(z.tooltip)&&z.tooltip(),g.append(z)),d.clear&&(t=a("<button/>",{disabled:!0}).html("clear").click(function(){A.empty(),t.prop("disabled",!0)}),g.append(t)),A.before(g),E.options.enableCookie&&B){var h=q(B+"-jsonUrl");h&&!C&&l(h)}E.isWidget=!0}E.options.jsonUrl&&(null===D&&l(E.options.jsonUrl),E.isWidget=!0)}function j(b){var c=E.options,d=c.jsonTemplate,e=c.onSuccess;D=h(b);var f=[];d.begin&&f.push(d.begin),g(f,d,D),d.end&&f.push(d.end),A.html(f.join("")),c.addClass&&A.addClass(c.addClass),m&&m.prop("disabled",!1),t&&t.prop("disabled",!1),s&&s.prop("disabled",!1),a.isFunction(e)&&e(A)}function k(a){C=a,z&&(""===C?z.prop("disabled",!0):(z.prop("disabled",!1),z.attr("title","reload from '"+C+"'"))),E.options.enableCookie&&B&&p(B+"-jsonUrl",C)}function l(b){var c=b;E.options.useProxy&&-1===b.indexOf(v)&&(c=v+b);var d;if(!E.options.allowCaching){var e=(new Date).getTime();d={cacheBuster:e}}a.getJSON(c,d).done(function(a,d){r("getJSON: '"+d+"' from "+c),k(b),j(a)}).fail(function(a,b,d){r("getJSON: '"+b+"' from "+c),r(d),r(a)})}var m=!1,s=!1,t=!1,z=!1,A=d,B=d.attr("id"),C=null,D=null,E=this;i(c)}function e(c){var d=a("<span/>"),e=a("<input />",{type:"file",css:{visibility:"hidden",width:0,height:0}});e.attr("accept","json"),e.on("change",function(a){var d=a.target.files,e=d[0],f=new b.FileReader;f.onload=function(){return function(a){var b=a.target.result,d=JSON.parse(b);c(d)}}(e),f.readAsText(e,"UTF-8")});var f=a("<button/>",{type:"button"});return f.html("load from file"),f.click(function(){e.click()}),d.append(f),d.append(e),d}function f(b){var c=a("<span/>"),d=a("<input />",{type:"text",size:"100"});d.bind("keypress",function(a){13===a.keyCode&&(a.preventDefault(),b(d.val()))});var e=a("<button/>",{type:"button"});return e.html("load from url"),e.click(function(){b(d.val())}),c.append(e),c.append(d),c}function g(a,b,c){if(Array.isArray(c.children))for(var d in c.children){var e=c.children[d];Array.isArray(e.children)?(a.push(b.beforeEachCategory+e.name+b.afterEachCategory),a.push(b.beforeChildren),g(a,b,e),a.push(b.afterChildren)):"string"==typeof e.uri?(b.beforeEachLink&&a.push(m(e,b.beforeEachLink,b)),b.eachLink&&a.push(m(e,b.eachLink,b)),b.afterEachLink&&a.push(m(e,b.afterEachLink,b))):(r("!!!!!! UNEXPECTED OBJECT !!!!!!"),r(e))}else r("!!!!!!!!!!  NOT A FOLDER   !!!!!!!!"),r(c)}function h(a){var b={};return Array.isArray(a)&&a.length>0&&"string"==typeof a[0].category&&Array.isArray(a[0].links)?(b.name="old format",b.children=i(a)):"text/x-moz-place-container"===a.type?(b.name="Mozilla Bookmarks",b.children=k(a)):"object"==typeof a.roots&&"object"==typeof a.roots.other?(b.name="Chrome Bookmarks",b.children=j(a.roots.other)):"string"==typeof a.name&&Array.isArray(a.children)?b=a:(b.name="!!!!!!!   UNEXPECTED FORMAT   !!!!!!!!!",b.children=[]),r(b.name),b}function i(b){var c=[];return a.each(b,function(b,d){if(d.category){var e=[];Array.isArray(d.links)&&a.each(d.links,function(a,b){if("string"==typeof b){var c={name:s.exec(b)[11],uri:b};e.push(c)}else if("string"==typeof b.link){var d={name:b.name,uri:b.link};e.push(d)}});var f={name:d.category,children:e};c.push(f)}}),r(b),c}function j(a){var b=[];if(Array.isArray(a.children))for(var c in a.children){var d=a.children[c];if("folder"===d.type&&Array.isArray(d.children)&&d.children.length>0){var e=j(d),f={name:d.name,children:e};b.push(f)}else if("url"===d.type){var g={name:d.name,uri:d.url};b.push(g)}}return b}function k(a){var b=[];if(Array.isArray(a.children))for(var c in a.children){var d=a.children[c];if("text/x-moz-place-container"===d.type&&Array.isArray(d.children)&&d.children.length>0){var e=k(d),f={name:d.title,children:e};b.push(f)}else if("text/x-moz-place"===d.type){var g={name:d.title,uri:d.uri};b.push(g)}}return b}function l(a){return t+s.exec(a)[11]}function m(a,b,c){var d="string"==typeof a.uri?a.uri:a,e="string"==typeof a.name?a.name:s.exec(d)[11],f=b.replace(c.replaceWithIconUrl,l(d));return f=f.replace(c.replaceWithSiteUrl,d),f=f.replace(c.replaceWithSiteName,e)}function n(a){var b=a?a:!1;if(!b)return!1;if(b===!0)return b={file:!0,url:!0,raw:!0,edit:!0,reload:!0,clear:!0};if("object"==typeof b)for(var c in b)if(b[c]===!0)return b;return!1}function o(c,d){var e=d?d:"LinkRoller";if(a.isFunction(a.fn.dialog)){var f=b.innerHeight-10,g=b.innerWidth-10,h=a("<iframe height='"+(f-100)+"' width='"+(g-100)+"' frameborder='0' marginwidth='0' marginheight='0' src='"+c+"' />"),i=a("<div id='mydialog' />");i.append(h),a("body").append(i),i.dialog({title:e,modal:!0,resizable:!0,height:"auto",width:g,close:function(){i.remove()}})}else{var j=b.open(c,e);j.focus()}}function p(a,d){var e=new Date;e.setTime(e.getTime()+A);var f=a+"="+b.escape(d)+"; expires="+e.toGMTString();r(f),c.cookie=f}function q(a){var d=c.cookie;r(d);var e=a+"=",f=d.indexOf(e);if(-1===f)return null;f+=e.length;var g=c.cookie.indexOf(";",f);-1===g&&(g=d.length),r("begin: "+f+" -- end:"+g);var h=d.substring(f,g);r("substring: "+h);var i=b.unescape(h);return r("value: "+i),i}function r(a){z&&b.console.log(a)}var s=/^(((([^:\/#\?]+:)?(?:(\/\/)((?:(([^:@\/#\?]+)(?:\:([^:@\/#\?]+))?)@)?(([^:\/#\?\]\[]+|\[[^\/\]@#?]+\])(?:\:([0-9]+))?))?)?)?((\/?(?:[^\/\?#]+\/+)*)([^\?#]*)))?(\?[^#]+)?)(#.*)?/,t="//www.google.com/s2/favicons?domain=",u=["append","prepend","before","after","html"],v="https://jsonp.nodejitsu.com/?callback=?&url=",w="https://jsonblob.com",x="/api/jsonBlob",y=b.File&&b.FileReader&&b.FileList,z=b.console&&b.console.log&&!0,A=31536e6;a.fn.linkroll=function(b){return this.each(function(){var c=a(this),e=new d(b,c);e.isWidget||(c.is("a")?e.insertImage(c):c.find("a").each(function(){var b=a(this);e.insertImage(b)}),a.isFunction(e.options.onSuccess)&&e.options.onSuccess(c))})},a.fn.linkroll.methods=function(){return u.slice()},a.fn.linkroll.defaults={addClass:"linkroll",method:"append",jsonUrl:!1,enableCookie:!0,allowCaching:!1,useProxy:!1,onSuccess:!1,buttons:{file:!1,url:!1,raw:!1,edit:!1,reload:!1,clear:!1},jsonTemplate:{begin:"",beforeEachCategory:"<h3>",eachCategory:"<h3>##CATEGORY##</h3>",afterEachCategory:"</h3>",beforeChildren:"<div><ul>",afterChildren:"</ul></div>",beforeEachLink:"",eachLink:"<li class='linkroll' style=\"list-style-image: url('##ICONURL##');\"><a href='##SITEURL##'>##SITENAME##</a></li>",afterEachLink:"",end:"",replaceWithCategory:"##CATEGORY##",replaceWithIconUrl:"##ICONURL##",replaceWithSiteUrl:"##SITEURL##",replaceWithSiteName:"##SITENAME##"}},d.prototype={options:{},isWidget:!1,insertImage:function(b){var c=a(b).attr("href"),d=l(c),e=a("<img />",{src:d});this.options.addClass&&(e.addClass(this.options.addClass),b.addClass(this.options.addClass));var f=b[this.options.method];f.call(b,e)}}}(jQuery,window,document);