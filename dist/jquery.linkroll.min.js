/**
 * jquery-linkroll - v0.0.2 2015-02-23
 * A jQuery plugin to format a JSON bookmark file.
 * https://github.com/zachofalltrades/jquery.linkroll
 *
 * Copyright (c)2015 Zach Shelton
 * <zachofalltrades@users.sourceforge.net>  (http://zachofalltrades.net)
 * Released Under License:  MIT,GPL 
 */
!function(a,b){"use strict";function c(c,h){function i(c){A.options=a.extend({},a.fn.linkroll.defaults,c),A.options.method=a.inArray(A.options.method,r)?A.options.method:r[0],A.options.jsonUrl&&(l(A.options.jsonUrl),A.isWidget=!0);var f=A.options.buttons?A.options.buttons:!1;if(f===!0&&(f={file:!0,url:!0,raw:!0,edit:!0,reload:!0,clear:!0}),m(f)){var g=a("<div/>");f.file&&v&&g.append(d(k)),f.url&&g.append(e(l)),f.raw&&v&&(o=a("<button/>",{type:"button",disabled:!0}),o.html("export"),o.click(function(){var a=z,c=JSON.stringify(a,null," "),d=new b.Blob([c],{type:"application/json"});n(b.URL.createObjectURL(d),"LinkRoller Data")}),g.append(o)),f.edit&&v&&(p=a("<button/>",{type:"button",disabled:!0}),p.html("edit"),p.click(function(){var c=y&&y.indexOf(t)>-1?!0:!1;if(c){var d=y.replace(u,"");n(d,"editing via JSONBlob service, save here, then reload")}else{var e=JSON.stringify(z);a.ajax({url:t+u,contentType:"application/json; charset=utf-8",type:"POST",data:e,error:function(a,c){b.alert(c)},success:function(a,b,c){y=c.getResponseHeader("location");var d=y.replace(u,"");n(d,"editing via JSONBlob service, save here, then reload")}})}}),g.append(p)),f.reload&&(w=a("<button/>",{disabled:!0}).html("reload").click(function(){l(y)}),w.tooltip(),g.append(w)),f.clear&&(q=a("<button/>",{disabled:!0}).html("clear").click(function(){x.empty(),q.prop("disabled",!0)}),g.append(q)),x.before(g),A.isWidget=!0}}function j(a){var b=a;A.options.useProxy&&-1===a.indexOf(s)&&(b=s+a),y=b,w&&(""===b?w.prop("disabled",!0):(w.prop("disabled",!1),w.attr("title","reload from '"+b+"'")))}function k(b){var c=A.options,d=c.jsonTemplate,e=c.onSuccess;z=g(b);var h=[];d.begin&&h.push(d.begin),f(h,d,z),d.end&&h.push(d.end),x.html(h.join("")),c.addClass&&x.addClass(c.addClass),o&&o.prop("disabled",!1),q&&q.prop("disabled",!1),p&&p.prop("disabled",!1),a.isFunction(e)&&e(x)}function l(b){j(b),a.getJSON(y).done(function(a){k(a)})}var o,p,q,w,x=h,y=null,z=null,A=this;i(c)}function d(c){var d=a("<span/>");if(v){var e=a("<input />",{type:"file",css:{visibility:"hidden",width:0,height:0}});e.attr("accept","json"),e.on("change",function(a){var d=a.target.files,e=d[0],f=new b.FileReader;f.onload=function(){return function(a){var b=a.target.result,d=JSON.parse(b);c(d)}}(e),f.readAsText(e,"UTF-8")});var f=a("<button/>",{type:"button"});f.html("load from file"),f.click(function(){e.click()}),d.append(f),d.append(e)}else d.html(y);return d}function e(b){var c=a("<span/>"),d=a("<input />",{type:"text"});d.bind("keypress",function(a){13===a.keyCode&&(a.preventDefault(),b(d.val()))});var e=a("<button/>",{type:"button"});return e.html("load from url"),e.click(function(){b(d.val())}),c.append(e),c.append(d),c}function f(a,b,c){if(Array.isArray(c.children))for(var d in c.children){var e=c.children[d];Array.isArray(e.children)?(a.push(b.beforeEachCategory+e.name+b.afterEachCategory),a.push(b.beforeChildren),f(a,b,e),a.push(b.afterChildren)):"string"==typeof e.uri?(b.beforeEachLink&&a.push(l(e,b.beforeEachLink,b)),b.eachLink&&a.push(l(e,b.eachLink,b)),b.afterEachLink&&a.push(l(e,b.afterEachLink,b))):(o("!!!!!! UNEXPECTED OBJECT !!!!!!"),o(e))}else o("!!!!!!!!!!  NOT A FOLDER   !!!!!!!!"),o(c)}function g(a){var b={};return Array.isArray(a)&&a.length>0&&"string"==typeof a[0].category&&Array.isArray(a[0].links)?(b.name="old format",b.children=h(a)):"text/x-moz-place-container"===a.type?(b.name="Mozilla Bookmarks",b.children=j(a)):"object"==typeof a.roots&&"object"==typeof a.roots.other?(b.name="Chrome Bookmarks",b.children=i(a.roots.other)):"string"==typeof a.name&&Array.isArray(a.children)?b=a:(b.name="!!!!!!!   UNEXPECTED FORMAT   !!!!!!!!!",b.children=[]),o(b.name),b}function h(a){var b=[];return o(a),b}function i(a){var b=[];if(Array.isArray(a.children))for(var c in a.children){var d=a.children[c];if("folder"===d.type&&Array.isArray(d.children)&&d.children.length>0){var e=i(d),f={name:d.name,children:e};b.push(f)}else if("url"===d.type){var g={name:d.name,uri:d.url};b.push(g)}}return b}function j(a){var b=[];if(Array.isArray(a.children))for(var c in a.children){var d=a.children[c];if("text/x-moz-place-container"===d.type&&Array.isArray(d.children)&&d.children.length>0){var e=j(d),f={name:d.title,children:e};b.push(f)}else if("text/x-moz-place"===d.type){var g={name:d.title,uri:d.uri};b.push(g)}}return b}function k(a){return q+p.exec(a)[11]}function l(a,b,c){var d="string"==typeof a.uri?a.uri:a,e="string"==typeof a.name?a.name:p.exec(d)[11],f=b.replace(c.replaceWithIconUrl,k(d));return f=f.replace(c.replaceWithSiteUrl,d),f=f.replace(c.replaceWithSiteName,e)}function m(a){if("object"==typeof a)for(var b in a)if(a[b]===!0)return!0;return!1}function n(c,d){var e=d?d:"LinkRoller";if(w){var f=b.innerHeight-10,g=b.innerWidth-10,h=a("<iframe height='"+(f-100)+"' width='"+(g-100)+"' frameborder='0' marginwidth='0' marginheight='0' src='"+c+"' />"),i=a("<div id='mydialog' />");i.append(h),a("body").append(i),i.dialog({title:e,modal:!0,resizable:!0,height:"auto",width:g,close:function(){i.remove()}})}else{var j=b.open(c,e);j.focus()}}function o(a){x&&b.console.log(a)}var p=/^(((([^:\/#\?]+:)?(?:(\/\/)((?:(([^:@\/#\?]+)(?:\:([^:@\/#\?]+))?)@)?(([^:\/#\?\]\[]+|\[[^\/\]@#?]+\])(?:\:([0-9]+))?))?)?)?((\/?(?:[^\/\?#]+\/+)*)([^\?#]*)))?(\?[^#]+)?)(#.*)?/,q="//www.google.com/s2/favicons?domain=",r=["append","prepend","before","after","html"],s="https://jsonp.nodejitsu.com/?callback=?&url=",t="https://jsonblob.com",u="/api/jsonBlob",v=b.File&&b.FileReader&&b.FileList,w=a.isFunction(a.fn.dialog),x=b.console&&b.console.log&&!0,y="feature not supported";a.fn.linkroll=function(b){return this.each(function(){var d=a(this),e=new c(b,d);return e.isWidget||(d.is("a")?e.insertImage(d):d.find("a").each(function(){var b=a(this);e.insertImage(b)}),a.isFunction(e.options.onSuccess)&&e.options.onSuccess(d)),this})},a.fn.linkroll.methods=function(){return r.slice()},a.fn.linkroll.defaults={addClass:"linkroll",method:"append",jsonUrl:!1,useProxy:!1,onSuccess:!1,buttons:{file:!1,url:!1,raw:!1,edit:!1,reload:!1,clear:!1},jsonTemplate:{begin:"",beforeEachCategory:"<h3>",eachCategory:"<h3>##CATEGORY##</h3>",afterEachCategory:"</h3>",beforeChildren:"<div><ul>",afterChildren:"</ul></div>",beforeEachLink:"",eachLink:"<li class='linkroll' style=\"list-style-image: url('##ICONURL##');\"><a href='##SITEURL##'>##SITENAME##</a></li>",afterEachLink:"",end:"",replaceWithCategory:"##CATEGORY##",replaceWithIconUrl:"##ICONURL##",replaceWithSiteUrl:"##SITEURL##",replaceWithSiteName:"##SITENAME##"}},c.prototype={options:{},isWidget:!1,insertImage:function(b){var c=a(b).attr("href"),d=k(c),e=a("<img />",{src:d});this.options.addClass&&(e.addClass(this.options.addClass),b.addClass(this.options.addClass));var f=b[this.options.method];f.call(b,e)}}}(jQuery,window,document);